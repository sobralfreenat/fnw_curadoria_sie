<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FNW - Custom Edtech 5.2.1 - GERiAH</title>
    <style>
        /* Reset de overflow para layout fixo */
        html, body { height: 100%; margin: 0; padding: 0; }
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-image: linear-gradient(to bottom, #503060, #3B204A);
            background-color: #3B204A; /* Fallback */
            color: #e5e5e5; /* Cor de texto padrão clara */
            padding-top: 70px !important; /* Espaço para o header fixo */
        }
        /* Header fixo GERiAH */
        header { 
            position: fixed !important; 
            top: 0 !important; 
            left: 0 !important; 
            right: 0 !important; 
            height: 70px; 
            background-color: rgba(71, 71, 71, 0.452);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #fff; 
            display: flex; 
            align-items: center; 
            padding: 0 20px; 
            z-index: 9999 !important; /* Z-index alto */
            border-bottom: 1px solid rgba(255,255,255,0.1); /* Linha sutil de separação */
        }
        header h3 { /* Ajuste no título do header */
            margin: 0; 
            font-size: 1.2em; 
            font-weight: normal;
        }
        /* Estilos para o botão de toggle do menu (hamburger) */
        .menu-toggle {
            display: block !important; /* Força a exibição do botão hamburger */
            background: transparent;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            padding: 5px 10px;
            z-index: 10000 !important; /* Garante que fique acima de outros elementos do header */
            margin-right: 15px;
            line-height: 1;
        }
        /* Sidebar abaixo do header */
        aside { 
            position: fixed; 
            top: 70px !important; /* Abaixo do header GERiAH */
            bottom: 0; 
            left: 0; 
            width: 180px; 
            background: rgba(42, 26, 58, 0.8); /* Tom de roxo GERiAH com transparência */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-right: 1px solid rgba(80, 48, 96, 0.7); 
            overflow-y: auto; 
            padding: 15px 15px 20px 15px; /* REINTRODUZIDO padding-top de 15px na aside */
            z-index: 990; /* Abaixo do header mas acima do main */
            transition: transform 0.3s ease-in-out; /* Transição para o slide-in/out */
        }
        /* Adicionado para espaçar a primeira categoria do topo da sidebar */
        aside .accordion-item:first-of-type {
            margin-top: 20px; /* Espaço do topo da sidebar */
        }
        /* Novo estilo para o separador cego */
        .category-separator {
            height: 15px; /* Altura do espaçador */
            background-color: rgba(26, 15, 33, 0.3); /* AJUSTADO: Púrpura mais escuro com 30% de transparência */
            margin: 15px 0; /* Margem vertical para espaçar */
            border-radius: 3px;
        }
        aside h2 { 
            margin-top: 0; /* Garante que o h2 respeite o margin-bottom do botão acima */
            font-size: 1.1em; 
            color: #fff; 
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(80, 48, 96, 0.7);
            font-weight: bold;
        }
        #categoriesList {
            list-style: none; 
            /* padding: 0; Removido daqui, será tratado pelo .accordion-content */
        }
        #categoriesList li { margin-bottom: 8px; }
        /* #categoriesList button { // Comentado para usar o seletor mais genérico abaixo
            width: 100%; 
            padding: 10px 15px; 
            text-align: left; 
            border: none; 
            background: transparent; 
            color: #d3d3d3; 
            cursor: pointer; 
            border-radius: 4px; 
            font-size: 0.95em;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        #categoriesList button.active, #categoriesList button:hover { 
            background: rgba(80, 48, 96, 0.9); 
            color: #fff; 
            font-weight: bold;
        } */

        /* Novo seletor genérico para botões dentro dos acordeões da sidebar */
        aside .accordion-content ul li button {
            width: 100%; 
            padding: 10px 15px; 
            text-align: left; 
            border: none; 
            background: transparent; 
            color: #d3d3d3; /* Lightgray para itens não ativos */
            cursor: pointer; 
            border-radius: 4px; 
            font-size: 1.125em;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        aside .accordion-content ul li button:hover,
        aside .accordion-content ul li button.active { /* .active ainda é útil para categorias */
            background: rgba(80, 48, 96, 0.9); /* Roxo mais forte para ativo/hover */
            color: #fff; 
            font-weight: bold;
        }

        #myCoursesBtn { 
            /* Estilos de posicionamento fixo na aside removidos */
            /* z-index: 10; */
            /* background-color: #2A1A3A; */ 

            /* width:100%; */ /* Não mais 100% da aside */
            padding: 8px 15px; /* Padding ajustado para o header */
            color:#fff; 
            border: 1px solid #fff; 
            border-radius:4px; 
            background: transparent; /* Fundo transparente no header */
            cursor:pointer; 
            margin-left: auto; /* Empurra o botão para a direita do header */
            margin-right: 10px; /* Pequena margem da borda direita do header */
            /* margin-bottom removido pois não é mais relevante para o fluxo da aside */
            font-weight: bold;
            font-size: 0.9em; /* Levemente reduzido para o header */
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        #myCoursesBtn:hover { 
            background: rgba(255,255,255,0.1); /* Hover sutil no header */
            color: #fff;
        }
        /* Conteúdo ao lado da sidebar, abaixo do header */
        main { 
            margin-left: 180px; /* Largura da sidebar */
            padding: 70px 30px 20px 30px; /* AJUSTADO padding-top para 70px (era 8px) */
            background-color: #100818; /* MAIS ESCURO: Fundo sólido para o main, próximo ao preto */
            transition: margin-left 0.3s ease-in-out; /* Transição para o push/pull */
        }
        main h1 { /* Este é o #mainTitle - agora usado apenas se necessário ou pode ser removido do JS */
            margin-top: 0; 
            color: #fff; 
        }
        /* Estilo para o título da categoria quando exibido acima do carrossel */
        .category-title-header {
            font-size: 1.8em; 
            color: #fff; 
            margin-bottom: 30px; /* AJUSTADO (era 60px) para aproximar o carrossel do título */
            padding-bottom: 10px; 
            border-bottom: 1px solid rgba(80, 48, 96, 0.7);
        }

        /* Removido .courses-grid, agora usamos .carousel-track */
        .carousel-track {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden; /* Esconde scrollbar vertical se houver */
            padding: 120px 500px 130px 500px; 
            margin-bottom: 1px; /* AJUSTADO (era 10px) */
            position: relative; /* Necessário para posicionar os pseudo-elementos do esfumaçado */
            /* Adicionando perspectiva para transformações 3D dos cards */
            perspective: 1200px;
            transform-style: preserve-3d; /* Garante que os filhos sejam tratados em 3D */
            /* Estilizando a scrollbar horizontal para o trilho */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: rgba(70, 40, 86, 0.9) rgba(30, 18, 40, 0.7); /* Firefox: thumb track - AJUSTADO */
        }
        .carousel-track::-webkit-scrollbar {
            height: 12px; /* AJUSTADO (era 8px) */
        }
        .carousel-track::-webkit-scrollbar-track {
            background: rgba(30, 18, 40, 0.7); /* AJUSTADO (era rgba(42, 26, 58, 0.5)) */
        }
        .carousel-track::-webkit-scrollbar-thumb {
            background: rgba(70, 40, 86, 0.9); /* AJUSTADO (era rgba(80, 48, 96, 0.8)) */
            border-radius: 4px;
        }
        .carousel-track::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 68, 116, 1); 
        }

        /* Pseudo-elementos para o efeito de esfumaçar nas laterais do carrossel */
        .carousel-track::before, .carousel-track::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0; 
            width: 280px; /* AUMENTADO: Largura da faixa de esfumaçamento (era 180px) */
            z-index: 2; 
            pointer-events: none; 
        }
        .carousel-track::before {
            left: 0;
            /* AJUSTADO: Degradê com início na cor do novo fundo do main mais dominante e transição mais para dentro */
            background: linear-gradient(to right, #100818 60%, rgba(16, 8, 24, 0.65) 85%, rgba(16, 8, 24, 0) 100%);
        }
        .carousel-track::after {
            right: 0;
            /* AJUSTADO: Degradê com início na cor do novo fundo do main mais dominante e transição mais para dentro */
            background: linear-gradient(to left, #100818 60%, rgba(16, 8, 24, 0.65) 85%, rgba(16, 8, 24, 0) 100%);
        }

        .course-card { 
            background: rgba(63, 44, 80, 0.7); 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border:1px solid rgba(80, 48, 96, 0.9); 
            border-radius: 8px; 
            overflow:hidden; 
            box-shadow:0 4px 8px rgba(0,0,0,0.3); 
            cursor: pointer; 
            color: #e5e5e5;
            width: 308px; /* AUMENTADO 40% (de 220px) */
            flex-shrink: 0; 
            margin-right: 2px; /* MARGEM MÍNIMA para evitar que colem totalmente sem transform */
            transition: transform 0.4s ease-in-out, box-shadow 0.4s ease-in-out, opacity 0.4s ease-in-out, filter 0.4s ease-in-out, z-index 0s 0.2s; 
            opacity: 0.1; 
            filter: brightness(0.1); 
            /* Transform inicial: recuado e menor. translateX e rotateY serão via JS para vizinhos */
            transform: translateZ(-200px) scale(0.8);
            transform-origin: center center; 
        }
        .course-card:last-child {
            margin-right: 0; 
        }
        .course-card:hover {
            /* Hover mantém uma escala mais próxima do 'normal' mas ainda se destaca dos distantes */
            transform: scale(1.12); /* Mantém scale uniforme no hover, sem espremer */
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
            z-index: 10; 
            opacity: 0.95; 
            filter: brightness(0.9); 
        }
        /* Nova classe para o card focado no centro do carrossel */
        .course-card.focused-card {
            /* EFEITO 3D: Card focado vem para frente e aumenta */
            transform: translateZ(60px) scale(1.12); /* Leve ajuste no scale/translateZ do focado */
            box-shadow: 0 20px 45px rgba(0,0,0,0.8); 
            z-index: 20; 
            opacity: 1; 
            filter: brightness(1); 
        }
        /* Classe para cards adjacentes (nível 1) ao focado - Usada para opacidade/brilho */
        .course-card.adjacent-style {
            opacity: 0.6; 
            filter: brightness(0.6); 
            /* transform é aplicado via JS */
        }
        /* Classe para cards vizinhos de segundo nível - Usada para opacidade/brilho */
        .course-card.secondary-neighbor-style {
            opacity: 0.3;
            filter: brightness(0.3);
            /* transform é aplicado via JS */
        }
        .course-card img { 
            width:100%; 
            height:196px; /* AUMENTADO 40% (de 140px) */
            object-fit:cover; 
            border-bottom: 1px solid rgba(80, 48, 96, 0.9);
        }
        .course-card .info { 
            padding:15px; 
        }
        .course-card h3 { 
            margin:0 0 10px; 
            font-size:1.05em; 
            color:#fff; 
            height: 56px; /* AUMENTADO 40% (de 40px) */
            overflow: hidden;
        }
        .course-card p { 
            font-size:0.85em; 
            color:#ccc; /* Cor da descrição um pouco mais clara */
            margin:0; 
            line-height: 1.3;
            height: 70px; /* AUMENTADO 40% (de 50px) */
            overflow: hidden;
        }
        /* Modal */
        .modal { 
            position: fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background: rgba(0,0,0,0.8); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1001; /* Mais alto que o header */
        }
        .modal.hidden { display: none; }
        .modal-content { 
            background: rgba(59, 32, 74, 0.95); /* Roxo GERiAH para modal */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #fff;
            width: 90%; 
            max-width: 700px; 
            padding: 25px; 
            border-radius:6px; 
            border: 1px solid rgba(80, 48, 96, 1);
            position: relative; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .modal-content img { 
            width:100%; 
            height:auto; 
            margin-bottom:20px; 
            border-radius: 4px; 
        }
        .modal-content h2 { 
            margin-top: 0; 
            font-size: 1.6em;
            margin-bottom: 15px;
        }
        .modal-content p {
            font-size: 1em;
            line-height: 1.6;
            color: #e0e0e0;
            margin-bottom: 10px;
        }
        .close { 
            position: absolute; 
            top: 15px; 
            right: 20px; 
            font-size: 1.8em; 
            color: #aaa; 
            cursor: pointer; 
            transition: color 0.2s ease;
        }
        .close:hover {
            color: #fff;
        }
        /* Scrollbar customizada (Webkit) - GERiAH Style */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(42, 26, 58, 0.5); /* Roxo translúcido para track */
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(80, 48, 96, 0.8); /* Roxo mais sólido para thumb */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 68, 116, 1); /* Roxo mais claro no hover */
        }

        /* Estilos para Acordeão na Sidebar */
        aside .accordion-item {
            border-bottom: 1px solid rgba(80, 48, 96, 0.7);
            margin-bottom: 25px; /* AJUSTADO: Maior espaçamento entre os itens principais */
        }

        aside .accordion-header { /* Estilo para os H2 que são cabeçalhos de acordeão */
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding-bottom: 15px; /* AJUSTADO: Mais espaço abaixo do cabeçalho */
            margin-bottom: 0;
            font-size: 1.1em;
            color: #fff; 
            font-weight: bold;
            margin-top: 0; /* Garante que não haja margem superior extra */
        }
        /* Removemos o estilo global de aside h2 para não conflitar com accordion-header */
        /* aside h2 { ... } */


        aside .accordion-icon {
            font-size: 0.8em;
            margin-left: 10px;
        }

        aside .accordion-content {
            padding-left: 10px; 
            padding-top: 5px; 
            padding-bottom: 10px; 
            display: none; /* Começa fechado */
        }
        aside .accordion-content ul { /* Para #categoriesList e #toolsCategoriesList */
            padding: 0; 
            margin:0;
            list-style: none; /* Garante que não haja marcadores de lista padrão */
        }
        aside .accordion-content ul li {
            margin-bottom: 15px; /* AJUSTADO: Espaçamento entre itens das subcategorias */
        }
        /* Fim Estilos Acordeão */

        /* Ajustes para o Modal de Curadoria - GERiAH Style */
        #curationModal .modal-content {
            /* Herda a maioria dos estilos de .modal-content */
            background: rgba(59, 32, 74, 0.98); /* Um pouco mais opaco para legibilidade */
        }
        /* Estilos para o Modal P.A.I (Painel de Acesso Imediato) */
        #paiModal .modal-content {
            /* Ajustes específicos se necessário, por ex, para altura do iframe */
            /* background: rgba(50, 25, 65, 0.98); /* Um roxo um pouco diferente se desejar */
            height: 90%; /* Ajustar conforme necessidade */
            width: 90%; /* Ajustar conforme necessidade */
            max-width: 1400px; /* Um pouco maior para ferramentas complexas */
            display: flex; /* Para organizar título e iframe */
            flex-direction: column; /* Título acima, iframe abaixo */
        }
        #paiModal iframe {
            flex-grow: 1; /* Iframe ocupa o espaço restante */
            border-radius: 0 0 6px 6px; /* Se o modal-content tiver border-radius */
        }

        #curationModal h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #fff;
        }
        #curationConfirm p, #curationReview h3, #curationList li {
            color: #e5e5e5;
        }
        #curationConfirm button, #curationReview button {
            background-color: rgba(100, 68, 116, 0.9); /* Roxo GERiAH para botões */
            color: white;
            border: 1px solid rgba(120, 88, 136, 1);
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        #curationConfirm button:hover, #curationReview button:hover {
            background-color: rgba(120, 88, 136, 1);
            border-color: rgba(140, 108, 156, 1);
        }
        #curationConfirm button#curateNo, #curationReview button#curateBack { /* Botão secundário */
            background-color: rgba(70, 70, 70, 0.8);
            border-color: rgba(90,90,90,1);
        }
        #curationConfirm button#curateNo:hover, #curationReview button#curateBack:hover {
            background-color: rgba(90, 90, 90, 0.9);
            border-color: rgba(110,110,110,1);
        }
        #curationList input[type=checkbox] {
            margin-right: 8px;
            accent-color: #804C9A; /* Cor roxa para o checkbox */
        }

        /* Media Query para Telas Pequenas (Mobile) */
        @media (max-width: 768px) {
            body { padding-top: 70px; } /* Ajusta padding do body */
            header {
                justify-content: flex-start; /* Alinha itens à esquerda */
            }
            .menu-toggle {
                display: block; /* Mostra o botão hamburger no mobile */
            }
            aside {
                transform: translateX(-100%); /* Esconde a sidebar por padrão no mobile */
                left: 0; /* Garante que o ponto de partida seja 0 */
                box-shadow: 2px 0 5px rgba(0,0,0,0.3); /* Sombra para destacar quando aberta */
            }
            main {
                margin-left: 0; /* Main ocupa largura total quando sidebar está oculta */
            }

            /* Estado: Sidebar aberta */
            body.sidebar-open aside {
                transform: translateX(0); /* Mostra a sidebar */
            }
            body.sidebar-open main {
                margin-left: 180px; /* Main é empurrado para a direita pela sidebar */
            }
            /* Opcional: Adicionar um overlay escuro quando a sidebar estiver aberta */
            body.sidebar-open::after {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 980; /* Abaixo da sidebar, acima do main */
            }

            /* Ajustes para o botão de Meus Cursos no mobile */
            #myCoursesBtn {
                margin-left: auto; /* Empurra para a direita para alinhar ao final do header */
            }

            .carousel-track {
                /* Reduzir padding para telas menores */
                padding: 80px 60px 80px 60px;
            }

            .carousel-track::before,
            .carousel-track::after {
                width: 100px; /* Largura do esfumaçado reduzida */
            }

            .carousel-track::before {
                background: linear-gradient(to right, #100818 30%, rgba(16, 8, 24, 0.65) 75%, rgba(16, 8, 24, 0) 100%);
            }

            .carousel-track::after {
                background: linear-gradient(to left, #100818 30%, rgba(16, 8, 24, 0.65) 75%, rgba(16, 8, 24, 0) 100%);
            }
        }

        .access-course-button {
            background-color: #804C9A; /* Roxo GERiAH */
            color: white;
            border: none;
            padding: 8px 15px;
            margin-top: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease;
            display: block; /* Ocupa a largura total */
            width: calc(100% - 0px); /* Ajusta para preencher o info div */
            text-align: center;
            text-decoration: none; /* Remove underline para links */
        }
        .access-course-button:hover {
            background-color: #6C3D82; /* Roxo mais escuro no hover */
        }
        /* Fim Novos estilos para botão Acessar */
    </style>
</head>
<body>
    <header>
        <button id="menuToggle" class="menu-toggle">☰</button>
        <h3>Catálogo de Recursos</h3>
        <button id="myCoursesBtn">iA</button>
    </header>
    <aside>
        <div class="accordion-item">
            <h2 class="accordion-header">Conteudo de Apoio <span class="accordion-icon">▼</span></h2>
            <div class="accordion-content">
                <ul id="categoriesList"><li>Carregando...</li></ul>
            </div>
        </div>
        <div class="category-separator"></div>
        <div class="accordion-item">
            <h2 class="accordion-header">Ferramentas - Acesso Imediato <span class="accordion-icon">▼</span></h2>
            <div class="accordion-content">
                <ul id="paiItemsList"><li>Nenhuma categoria F.A.I. configurada.</li></ul>
            </div>
        </div>
        <div class="category-separator"></div>
        <div class="accordion-item">
            <h2 class="accordion-header">Suporte - IA <span class="accordion-icon">▼</span></h2>
            <div class="accordion-content">
                <ul id="suporteIaItemsList"><li>Carregando subcategorias...</li></ul> 
            </div>
        </div>
        <div class="category-separator"></div>
        <div class="accordion-item">
            <h2 class="accordion-header">Participe <span class="accordion-icon">▼</span></h2>
            <div class="accordion-content">
                <ul id="participeItemsList"><li>Carregando...</li></ul>
            </div>
        </div>
    </aside>
    <main>
        <h1 id="mainTitle"></h1>
        <div id="coursesContainer"><p style="color: #ccc; text-align: center; margin-top: 50px; font-size: 1.2em;">Selecione uma categoria no Menu e acesse os recursos.</p></div>
    </main>

    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <span id="modalClose" class="close">&times;</span>
            <div id="courseDetails"></div>
        </div>
    </div>

    <!-- Modal de Curadoria -->
    <div id="curationModal" class="modal hidden">
      <div class="modal-content">
        <h2>Curadoria de Recursos</h2>
        <!-- Passo 1: adicionar/ignorar -->
        <div id="curationConfirm">
          <p id="curationMessage"></p>
          <p id="curationRemaining" style="font-weight:bold; margin:5px 0;"></p>
          <button id="curateYes">Sim</button>
          <button id="curateNo">Não</button>
          <button id="accessNowBtn" style="display:none;">Acessar Agora</button>
        </div>
        <!-- Passo 2: rever seleção com nome/email -->
        <div id="curationReview" style="display:none; margin-top:15px;">
          <h3>Revise sua seleção</h3>
          <ul id="curationList"></ul>
          <div style="margin-top:10px;">
            <button id="curateBack">Voltar</button>
            <button id="curateContinue">Continuar</button>
            <button id="curateFinish">Finalizar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- NOVO Modal P.A.I. -->
    <div id="paiModal" class="modal hidden">
        <div class="modal-content pai-modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom: 1px solid rgba(80, 48, 96, 0.7);">
                <h2 id="paiModalTitle" style="margin:0; font-size:1.4em; color: #fff;"></h2>
                <span id="paiModalClose" class="close" style="font-size:1.8em; cursor:pointer; color: #aaa;">&times;</span>
            </div>
            <iframe id="paiModalIframe" style="width:100%; height:100%; border:none; background-color: #fff;"></iframe>
        </div>
    </div>

    <script>
        const curationList = [];
        const MAX_CURATION = 4;

        // Nova estrutura para categorias P.A.I.
        const paiCategoriesData = [
            {
                name: "50+ | Maduros e Idosos",
                items: [
                    { name: "Longevidade", url: "https://longevidade.com.br/", image: "https://api.iconify.design/tabler/plant.svg?color=%23e5e5e5" }, 
                    { name: "Analise CNIS", url: "https://sobralfreenat.github.io/poc_avaliacao_cnis_aposentadoria/", image: "https://api.iconify.design/tabler/file-text.svg?color=%23e5e5e5" },
                    { name: "CNIS Suporte", url: "https://sobralfreenat.github.io/cnis_fluxo02_backoffice/", image: "https://api.iconify.design/tabler/tool.svg?color=%23e5e5e5" }
                ]
            },
            {
                name: "FNW Assessoria",
                items: [
                    { name: "Plataforma FNW Assessoria", url: "https://sobralfreenat.github.io/menu_fixo_replica/", image: "https://api.iconify.design/tabler/briefcase.svg?color=%23e5e5e5" },
                    { name: "FNW - Formulário Estratégico", url: "https://websim.com/@shiningrainbow72249063/formul-rio-estrat-gico", image: "https://api.iconify.design/tabler/file-text.svg?color=%23e5e5e5" },
                    { name: "FNW - ROI Maker", url: "https://sobralfreenat.github.io/fnw_clevel_roi-maker/", image: "https://api.iconify.design/tabler/calculator.svg?color=%23e5e5e5" },
                    { name: "Painel ETO", url: "https://sobralfreenat.github.io/fnw_connect_panel/", image: "https://api.iconify.design/tabler/layout-dashboard.svg?color=%23e5e5e5" },
                    { name: "Mapa Tatico SP MG", url: "https://sobralfreenat.github.io/mapa150_sp-106_mg/", image: "https://api.iconify.design/tabler/map-2.svg?color=%23e5e5e5" }
                ]
            }
        ];

        // Restaurando a estrutura de subcategorias para Suporte IA
        const suporteIaCategoriesData = [
            {
                name: "Wizzards",
                items: [
                    { name: "IA Prompt Wizzard", url: "https://sobralfreenat.github.io/agent_ai_prompt_gen_tool/", image: "https://api.iconify.design/tabler/wand.svg?color=%23e5e5e5" },
                    { name: "Plano de Aula - S", url: "https://sobralfreenat.github.io/fnw_plano_aula/", image: "https://api.iconify.design/tabler/school.svg?color=%23e5e5e5" }
                ]
            },
            {
                name: "Assistentes",
                items: [
                    { name: "Chat Rosio Livia Geriah", url: "https://sobralfreenat.github.io/chat_rosio_livia_geriah/", image: "https://api.iconify.design/tabler/message-dots.svg?color=%23e5e5e5" },
                    { name: "HumanIA", url: "https://dash.superagentes.ai/@humania", image: "https://api.iconify.design/tabler/users-group.svg?color=%23e5e5e5" },
                    { name: "London Lord", url: "https://sobralfreenat.github.io/agb_gabriel_bourne_master/", image: "https://api.iconify.design/tabler/user-hexagon.svg?color=%23e5e5e5" }
                ]
            },
            {
                name: "Agentes",
                items: [
                    { name: "Agente Exemplo 1", url: "#", image: "https://api.iconify.design/tabler/robot.svg?color=%23e5e5e5" },
                    { name: "Agente Exemplo 2", url: "#", image: "https://api.iconify.design/tabler/gizmo.svg?color=%23e5e5e5" }
                ],
                statusMessage: "" // Limpa a mensagem pois agora temos itens
            },
            {
                name: "Automações",
                items: [
                    { name: "Automação Exemplo 1", url: "#", image: "https://api.iconify.design/simple-icons/n8n.svg?color=%23e5e5e5" },
                    { name: "Automação Exemplo 2", url: "#", image: "https://api.iconify.design/simple-icons/make.svg?color=%23e5e5e5" }
                ],
                statusMessage: "" // Limpa a mensagem pois agora temos itens
            }
        ];

        // Nova estrutura para categoria "Participe"
        const participeCategoriesData = [
            {
                name: "Parcerias",
                items: [
                    { name: "IDEIA21", url: "https://websim.com/@shiningrainbow72249063/ideia21-instituto-de-design-estilo-imagem-e-arte", image: "https://api.iconify.design/tabler/user.svg?color=%23e5e5e5" },
                    { name: "IPSOLON", url: "https://websim.com/@shiningrainbow72249063/ipsolon-instituto-de-promo-o-da-sa-de-orientada-lo", image: "https://api.iconify.design/tabler/git-fork.svg?color=%23e5e5e5" }
                ]
            },
            {
                name: "Feito Por Você",
                items: [
                    { name: "Feito Por Você", url: "https://forms.gle/kFdaEY5L9gDYCUpC8", image: "https://api.iconify.design/tabler/edit.svg?color=%23e5e5e5" } // Use um ícone relevante
                ]
            }
        ];

        // Variáveis para parâmetros da URL e estado de embedding
        let urlParams = new URLSearchParams(window.location.search);
        let embeddedMode = urlParams.get('embedded') === 'true';
        let parentOrigin = urlParams.get('origin');
        let userToken = urlParams.get('userToken');
        let userId = urlParams.get('userId'); // Pode ser usado futuramente se necessário
        console.log('fnw_curadoria_sie: userToken from URL params:', userToken);
        console.log('fnw_curadoria_sie: embeddedMode from URL params:', embeddedMode);

        // Usa o token da URL se disponível, senão usa o fallback
        const apiToken = userToken || 'dbb2c4d19a5ef0fec48e363618611614b4e0dfce'; 

        const categoryUrl = 'https://www.iped.com.br/api/category/get-categories';
        const coursesUrl = 'https://www.iped.com.br/api/course/get-courses';

        const relevantKeywordsFor50Plus = [
            'saude', 'bem-estar', 'memoria', 'mente', 'corpo', 'nutricao', 'alimentacao', 'exercicio', 'ginastica', 'yoga', 'pilates', 'dança', 'esportes', 'fisioterapia',
            'artesanato', 'pintura', 'desenho', 'musica', 'canto', 'instrumento', 'fotografia',
            'historia', 'cultura', 'arte', 'literatura', 'idiomas', 'linguas', 'escrita',
            'finanças', 'investimentos', 'empreendedorismo', 'negocios', 'direito', 'aposentadoria',
            'jardinagem', 'horta', 'culinaria', 'gastronomia', 'receitas',
            'tecnologia', 'digital', 'informatica', 'internet', 'computador', 'celular', 'redes sociais',
            'viagem', 'turismo', 'lazer', 'jogos', 'espiritualidade', 'meditacao', 'qualidade de vida', 'voluntariado'
        ];

        // Função para ocultar o header e ajustar layout se em modo embedded
        function adjustForEmbeddedMode() {
            if (embeddedMode) {
                const headerElement = document.querySelector('header');
                const asideElement = document.querySelector('aside');
                const menuToggle = document.getElementById('menuToggle');

                // Forçar visibilidade e posicionamento do header no modo embarcado
                if (headerElement) {
                    headerElement.style.setProperty('display', 'flex', 'important');
                    headerElement.style.setProperty('position', 'fixed', 'important');
                    headerElement.style.setProperty('top', '0', 'important');
                    headerElement.style.setProperty('left', '0', 'important');
                    headerElement.style.setProperty('right', '0', 'important');
                    headerElement.style.setProperty('z-index', '9999', 'important');
                }
                // Forçar visibilidade e z-index do botão de menu (hambúrguer)
                if (menuToggle) {
                    menuToggle.style.setProperty('display', 'block', 'important');
                    menuToggle.style.setProperty('z-index', '10000', 'important');
                }
                // Ajusta o padding-top do body para 70px, pois o header está visível
                document.body.style.setProperty('padding-top', '70px', 'important');
                
                // Ajusta a posição do aside para o topo da página (abaixo do header)
                if (asideElement) {
                    asideElement.style.setProperty('top', '70px', 'important');
                }

                // --- Início da lógica restaurada para botões de curadoria no modo embarcado ---
                const accessNowBtn = document.getElementById('accessNowBtn');
                if (accessNowBtn) {
                    accessNowBtn.style.display = 'inline-block'; // Mostra o botão em modo embedded
                    // Estilizar como os outros botões:
                    accessNowBtn.style.backgroundColor = 'rgba(100, 68, 116, 0.9)';
                    accessNowBtn.style.color = 'white';
                    accessNowBtn.style.border = '1px solid rgba(120, 88, 136, 1)';
                    accessNowBtn.style.padding = '10px 15px';
                    accessNowBtn.style.margin = '5px';
                    accessNowBtn.style.borderRadius = '4px';
                    accessNowBtn.style.cursor = 'pointer';
                    accessNowBtn.style.fontWeight = 'bold';
                    accessNowBtn.addEventListener('click', () => {
                        if (current && parentOrigin) {
                            window.parent.postMessage({ action: 'acessarItem', itemId: current.course_id }, parentOrigin);
                            document.getElementById('curationModal').classList.add('hidden'); // Fecha o modal
                        }
                    });
                }
                 // No modo embedded, o botão "Sim" para adicionar à curadoria deve estar oculto
                const curateYesBtn = document.getElementById('curateYes');
                if(curateYesBtn) curateYesBtn.style.display = 'none';
                
                // No modo embedded, o botão "Não" (ignorar) deve estar oculto
                const curateNoBtn = document.getElementById('curateNo');
                if(curateNoBtn) curateNoBtn.style.display = 'none';
                 // Ajustar texto do prompt de curadoria em modo embedded
                const curationMessageEl = document.getElementById('curationMessage');
                if (curationMessageEl && current) {
                    curationMessageEl.textContent = `Acessar conteúdo "${current.course_title}"?`;
                }
                const curationRemainingEl = document.getElementById('curationRemaining');
                if(curationRemainingEl) curationRemainingEl.style.display = 'none'; // Não relevante para acesso direto
                // --- Fim da lógica restaurada para botões de curadoria no modo embarcado ---
            }
        }


        async function fetchCategories() {
            const ul = document.getElementById('categoriesList');
            ul.innerHTML = '<li>Carregando...</li>';
            try {
                const fd = new FormData();
                fd.append('token', apiToken);
                fd.append('all_formats', 'true');
                const res = await fetch(categoryUrl, { method: 'POST', body: fd });
                const data = await res.json();
                if (data.CATEGORIES) renderCategories(data.CATEGORIES);
                else ul.innerHTML = '<li>Erro ao carregar categorias.</li>';
            } catch {
                ul.innerHTML = '<li>Erro de rede.</li>';
            }
        }

        function renderCategories(cats) {
            const ul = document.getElementById('categoriesList');
            ul.innerHTML = '';
            let categoriesRendered = 0;

            cats.forEach((cat, idx) => {
                const categoryTitleLower = cat.category_title.toLowerCase();
                const isRelevant = relevantKeywordsFor50Plus.some(keyword => categoryTitleLower.includes(keyword));

                if (isRelevant) {
                    const li = document.createElement('li');
                    const btn = document.createElement('button');
                    btn.textContent = cat.category_title;
                    btn.dataset.id = cat.category_id;
                    btn.addEventListener('click', () => selectCategory(btn));
                    li.appendChild(btn);
                    ul.appendChild(li);
                    categoriesRendered++;
                }
            });

            if (categoriesRendered === 0) {
                ul.innerHTML = '<li>Nenhuma categoria de interesse para 50+ encontrada no momento.</li>';
            }
        }

        function selectCategory(btn) {
            // Atualiza classe ativa
            document.querySelectorAll('#categoriesList button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // Limpa o contêiner de cursos antes de buscar novos
            document.getElementById('coursesContainer').innerHTML = '<p style="color: #ccc;">Carregando recursos da categoria: ' + btn.textContent + '...</p>';
            fetchCourses(btn.dataset.id, btn.textContent);
            // Chama closeSidebar() após a seleção de categoria
            closeSidebar();
        }

        async function fetchCourses(catId, catTitle) {
            const cont = document.getElementById('coursesContainer');
            try {
                const fd = new FormData();
                fd.append('token', apiToken);
                fd.append('category_id', catId);
                fd.append('all_formats', 'true');
                const res = await fetch(coursesUrl, { method: 'POST', body: fd });
                const data = await res.json();
                if (data.COURSES) renderCourses(data.COURSES, catTitle);
                else cont.innerHTML = '<p style="color: #ff6b6b;">Erro ao carregar recursos.</p>';
            } catch {
                cont.innerHTML = '<p style="color: #ff6b6b;">Erro de rede ao buscar recursos.</p>';
            }
        }

        function renderCourses(courses, categoryTitle) {
            console.log('renderCourses: userToken value:', userToken);
            const container = document.getElementById('coursesContainer');
            container.innerHTML = '';

            // Cria o título da categoria principal (antigo #mainTitle, agora dinâmico)
            // Este título fica fora do carrossel, no topo da área de cursos.
            const categoryHeader = document.createElement('h2');
            categoryHeader.className = 'category-title-header'; // Reutiliza o estilo existente
            categoryHeader.textContent = categoryTitle;
            container.appendChild(categoryHeader);

            if (!courses || courses.length === 0) { // Verificação mais robusta
                // Se não há cursos, apenas mostra a mensagem abaixo do título da categoria.
                // Não cria o .carousel-track nem os pseudo-elementos de esfumaçar.
                const noCoursesMessage = document.createElement('p');
                noCoursesMessage.textContent = 'Nenhum recurso encontrado nesta categoria.';
                noCoursesMessage.style.color = '#ccc';
                noCoursesMessage.style.marginTop = '20px';
                container.appendChild(noCoursesMessage);
                return;
            }

            // Cria o trilho do carrossel
            const carouselTrack = document.createElement('div');
            carouselTrack.className = 'carousel-track';

            courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                if(course.course_id) card.dataset.courseId = course.course_id;

                let displayTitle = course.course_title || 'Curso sem título';
                if (displayTitle.toLowerCase().startsWith('curso de ')) {
                    displayTitle = displayTitle.substring(9); // Remove "Curso de " (9 caracteres)
                }

                card.innerHTML = `
                    <img src="${course.course_image || 'https://via.placeholder.com/308x196.png?text=Sem+Imagem'}" alt="${course.course_title || 'Curso sem título'}" style="width:100%; height:196px; object-fit:cover; border-bottom: 1px solid rgba(80, 48, 96, 0.9);">
                    <div class="info" style="padding:15px;">
                        <h3 style="margin:0 0 10px; font-size:1.05em; color:#fff; height: 56px; overflow: hidden;">${displayTitle}</h3>
                        <p style="font-size:0.85em; color:#ccc; margin:0; line-height: 1.3; height: 70px; overflow: hidden;">${(course.course_description || 'Sem descrição disponível.').substring(0, 100)}...</p>
                        ${userToken ? `<button class="access-course-button" data-course-id="${course.course_id}">Acessar</button>` : ''}
                    </div>`;

                if (userToken) {
                    // Se o usuário está logado, o clique no card não faz nada,
                    // e a ação de acesso é via o botão "Acessar".
                    // card.onclick = null; // Já é null por padrão se não for atribuído
                    const accessButton = card.querySelector('.access-course-button');
                    if (accessButton) {
                        accessButton.addEventListener('click', (e) => {
                            e.stopPropagation(); // Impede que o clique no botão propague para o card
                            if (course.course_id && parentOrigin) {
                                window.parent.postMessage({ action: 'acessarItem', itemId: course.course_id }, parentOrigin);
                            }
                            closeSidebar(); // Fechar sidebar após iniciar o acesso ao curso
                        });
                    }
                } else {
                    // Se o usuário NÃO está logado, o clique no card abre o modal de curadoria.
                    card.onclick = () => {
                        promptCurate(course);
                        // closeSidebar(); // REMOVIDO: Permitir que o menu hambúrguer funcione com o modal aberto
                    };
                }
                carouselTrack.appendChild(card);
            });
            container.appendChild(carouselTrack);

            // Adiciona listener de scroll ao carrossel recém-criado
            const debouncedUpdateFocus = debounce(() => updateCarouselFocus(carouselTrack), 50);
            
            let scrollEndTimer = null;
            carouselTrack.addEventListener('scroll', () => {
                // Atualiza o foco visualmente durante o scroll
                debouncedUpdateFocus(); 

                // Detecta o fim do scroll para o snap
                clearTimeout(scrollEndTimer);
                scrollEndTimer = setTimeout(() => {
                    snapToNearestCard(carouselTrack);
                }, 150); // Ajuste este valor se necessário (tempo para considerar o scroll parado)
            });

            // Chama uma vez para definir o foco inicial se houver scroll inicial
            updateCarouselFocus(carouselTrack); 
        }

        function snapToNearestCard(carouselTrack) {
            if (!carouselTrack || carouselTrack.children.length === 0) return;

            const cards = Array.from(carouselTrack.querySelectorAll('.course-card'));
            if (cards.length === 0) return;

            const trackRect = carouselTrack.getBoundingClientRect();
            const trackVisibleWidth = carouselTrack.clientWidth; // Largura visível, excluindo scrollbars
            const trackScrollLeft = carouselTrack.scrollLeft;

            let nearestCard = null;
            let smallestDistance = Infinity;

            // Calcula a "linha central" da área visível do carrossel
            const viewportCenterLine = trackScrollLeft + trackVisibleWidth / 2;

            cards.forEach(card => {
                const cardMidPoint = card.offsetLeft + card.offsetWidth / 2;
                const distance = Math.abs(viewportCenterLine - cardMidPoint);

                if (distance < smallestDistance) {
                    smallestDistance = distance;
                    nearestCard = card;
                }
            });

            if (nearestCard) {
                // Calcula o scrollLeft necessário para centralizar o nearestCard
                const targetScrollLeft = nearestCard.offsetLeft - (trackVisibleWidth / 2) + (nearestCard.offsetWidth / 2);
                
                // Só faz o scroll se a posição alvo for significativamente diferente da atual
                // para evitar loops de snap em alguns casos, e para não "snappar" se já estiver perto.
                if (Math.abs(carouselTrack.scrollLeft - targetScrollLeft) > 1) { 
                    carouselTrack.scrollTo({
                        left: targetScrollLeft,
                        behavior: 'smooth'
                    });
                    // A debouncedUpdateFocus no listener de scroll cuidará de atualizar o visual após a animação de snap.
                }
            }
        }

        // Função Debounce para otimizar eventos de scroll/resize
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Função para atualizar o foco no card central do carrossel
        function updateCarouselFocus(carouselTrack) {
            if (!carouselTrack || carouselTrack.children.length === 0) return;

            const trackRect = carouselTrack.getBoundingClientRect();
            const trackCenter = trackRect.left + trackRect.width / 2;
            const cards = Array.from(carouselTrack.querySelectorAll('.course-card'));

            const cardWidth = cards[0] ? cards[0].offsetWidth : 308;

            // --- Parâmetros Responsivos --- 
            const isMobile = window.innerWidth <= 768;

            // Parâmetros de estilo
            const MAX_SCALE = isMobile ? 1.15 : 1.28; 
            const MIN_SCALE = 0.8;
            const MAX_TRANSLATE_Z = isMobile ? 30 : 60; 
            const MIN_TRANSLATE_Z = isMobile ? -100 : -200;
            const MAX_OPACITY = 1.0;
            const MIN_OPACITY_EDGE = isMobile ? 0.6 : 0.4; 
            const MIN_OPACITY_FAR = isMobile ? 0.2 : 0.1; 
            const MAX_BRIGHTNESS = 1.0;
            const MIN_BRIGHTNESS_EDGE = isMobile ? 0.6 : 0.4;
            const MIN_BRIGHTNESS_FAR = isMobile ? 0.2 : 0.1;

            const BORDER_DARK_COLOR = '#21112E';
            const BORDER_LIGHT_COLOR = '#D3C5E0';
            const BORDER_THICKNESS = 2; 

            const FOCUS_ZONE_WIDTH = cardWidth * (isMobile ? 1.5 : 2.0); 

            const Y_ROTATE_PER_CARD = isMobile ? 5 : 10; 
            const Y_ROTATE_FOCUS_DAMPING = 0.4; 
            const X_TRANSLATE_BASE_FACTOR = cardWidth * (isMobile ? 0.15 : 0.25);
            // --- Fim Parâmetros Responsivos ---


            let centralCardIndex = -1;
            let minDistanceToTrackCenterForPivoting = Infinity;
            cards.forEach((card, index) => {
                const cardRect = card.getBoundingClientRect();
                const cardCenter = cardRect.left + cardRect.width / 2;
                const distance = Math.abs(cardCenter - trackCenter);
                if (distance < minDistanceToTrackCenterForPivoting) {
                    minDistanceToTrackCenterForPivoting = distance;
                    centralCardIndex = index;
                }
            });

            cards.forEach((card, index) => {
                const cardRect = card.getBoundingClientRect();
                const cardCenter = cardRect.left + cardRect.width / 2;

                const distanceToTrackCenterCurrentCard = Math.abs(cardCenter - trackCenter);
                let focusFactor = 1 - (distanceToTrackCenterCurrentCard / (FOCUS_ZONE_WIDTH / 2));
                focusFactor = Math.max(0, Math.min(1, focusFactor));

                const scale = MIN_SCALE + (MAX_SCALE - MIN_SCALE) * focusFactor;
                const translateZ = MIN_TRANSLATE_Z + (MAX_TRANSLATE_Z - MIN_TRANSLATE_Z) * focusFactor;
                
                let opacity, brightness;
                let boxShadow = `0 8px 20px rgba(0,0,0,${(0.3 + focusFactor * 0.5).toFixed(2)})`; // Sombra base interpolada

                if (focusFactor > 0.95) { // Ápice do foco
                    const elevationShadow = `0 20px 45px rgba(0,0,0,0.8)`;
                    const darkBorder = `0 0 0 ${BORDER_THICKNESS}px ${BORDER_DARK_COLOR}`;
                    const lightBorder = `0 0 0 ${BORDER_THICKNESS * 2}px ${BORDER_LIGHT_COLOR}`;
                    boxShadow = `${darkBorder}, ${lightBorder}, ${elevationShadow}`;
                } else if (focusFactor > 0.5) { // Zona de foco intermediária
                    const currentElevationAlpha = (0.3 + focusFactor * 0.5).toFixed(2);
                    boxShadow = `0 ${Math.round(8 + 12 * focusFactor)}px ${Math.round(20 + 25 * focusFactor)}px rgba(0,0,0,${currentElevationAlpha})`;
                } // Para focusFactor <= 0.5, a sombra base já definida é suficiente (menor e mais sutil)

                if (focusFactor > 0) {
                    opacity = MIN_OPACITY_EDGE + (MAX_OPACITY - MIN_OPACITY_EDGE) * focusFactor;
                    brightness = MIN_BRIGHTNESS_EDGE + (MAX_BRIGHTNESS - MIN_BRIGHTNESS_EDGE) * focusFactor;
                } else {
                    const falloffDistance = cardWidth * 1.5;
                    const distBeyondFocusZone = distanceToTrackCenterCurrentCard - (FOCUS_ZONE_WIDTH / 2);
                    const decay = Math.max(0, 1 - (distBeyondFocusZone / falloffDistance));
                    opacity = MIN_OPACITY_FAR + (MIN_OPACITY_EDGE - MIN_OPACITY_FAR) * decay;
                    brightness = MIN_BRIGHTNESS_FAR + (MIN_BRIGHTNESS_EDGE - MIN_BRIGHTNESS_FAR) * decay;
                }
                
                let translateX = 0;
                let rotateY = 0;

                if (centralCardIndex !== -1) {
                    const offsetFromCentral = index - centralCardIndex; 

                    rotateY = offsetFromCentral * Y_ROTATE_PER_CARD * (1 - (focusFactor * Y_ROTATE_FOCUS_DAMPING));

                    if (offsetFromCentral !== 0) {
                        // Cards são empurrados para os lados baseados no offset.
                        // Este efeito é atenuado se o card atual (index) estiver ele mesmo em foco.
                        translateX = offsetFromCentral * X_TRANSLATE_BASE_FACTOR * (1 - focusFactor * 0.6);
                    } else {
                        translateX = 0; // Card central não tem translateX relativo ao pivô.
                    }
                }
                
                card.style.transform = `translateX(${translateX.toFixed(1)}px) rotateY(${rotateY.toFixed(1)}deg) translateZ(${translateZ.toFixed(0)}px) scale(${scale.toFixed(2)})`;
                card.style.opacity = opacity.toFixed(2);
                card.style.filter = `brightness(${brightness.toFixed(2)})`;
                card.style.zIndex = Math.floor(translateZ + 200); 
                card.style.boxShadow = boxShadow;

                card.classList.remove('focused-card', 'adjacent-style', 'secondary-neighbor-style');
            });
        }

        async function openDetails(id) {
            try {
                const fd = new FormData();
                fd.append('token', apiToken);
                fd.append('course_id', id);
                const res = await fetch(coursesUrl, { method: 'POST', body: fd });
                const d = await res.json();
                if (d.COURSES && d.COURSES[0]) showModal(d.COURSES[0]);
            } catch {
                console.error('Erro ao carregar detalhes');
            }
        }

        function showModal(course) {
            const md = document.getElementById('modal');
            const div = document.getElementById('courseDetails');
            div.innerHTML = `
                <img src="${course.course_image || ''}">
                <h2>${course.course_title}</h2>
                <p>${course.course_description || ''}</p>
                <p><strong>Professor:</strong> ${course.course_teacher?.teacher_name || ''}</p>
                <p><strong>Preço:</strong> R$${course.course_price?.toFixed(2) || '--'}</p>`;
            md.classList.remove('hidden');
        }

        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('modal').classList.add('hidden');
        });

        document.getElementById('myCoursesBtn').addEventListener('click', () => {
            window.location.href = 'https://sobralfreenat.github.io/chat_rosio_livia_geriah/';
        });

        const MAX_SELECTION = 4;
        let selection = [];
        let current = null;
        
        function promptCurate(course) {
            current = course;
            const curationMessageEl = document.getElementById('curationMessage');
            const curationRemainingEl = document.getElementById('curationRemaining');
            const accessNowBtn = document.getElementById('accessNowBtn');
            const curateYesBtn = document.getElementById('curateYes');
            const curateNoBtn = document.getElementById('curateNo');

            if (embeddedMode) {
                if (curationMessageEl) curationMessageEl.textContent = `Acessar conteúdo "${current.course_title}"?`;
                if (curationRemainingEl) curationRemainingEl.style.display = 'none';
                if (accessNowBtn) accessNowBtn.style.display = 'inline-block';
                if (curateYesBtn) curateYesBtn.style.display = 'none';
                if (curateNoBtn) curateNoBtn.style.display = 'none';
            } else {
                if (curationMessageEl) curationMessageEl.textContent = `Adicionar "${course.course_title}" à sua curadoria?`;
                if (curationRemainingEl) {
                    curationRemainingEl.style.display = 'block';
                    curationRemainingEl.textContent = `Você pode selecionar ${MAX_SELECTION - selection.length} recurso${selection.length !== MAX_SELECTION-1?'s':''}`;
                }
                if (accessNowBtn) accessNowBtn.style.display = 'none';
                if (curateYesBtn) curateYesBtn.style.display = 'inline-block';
                if (curateNoBtn) curateNoBtn.style.display = 'inline-block';
            }
            
            document.getElementById('curationConfirm').style.display = 'block';
            document.getElementById('curationReview').style.display = 'none';
            document.getElementById('curationModal').classList.remove('hidden');
        }

        document.getElementById('curateYes').onclick = () => {
            if (selection.length < MAX_SELECTION && !selection.find(c => c.course_id === current.course_id)) {
                selection.push(current);
            }
            // Se não estiver em modo embedded, vai para a revisão.
            // Se estiver em modo embedded, este botão não deveria ser clicável ou visível.
            if (!embeddedMode) {
                showReview();
            } else {
                // Em modo embedded, o fluxo de curadoria é diferente, "Sim" não se aplica diretamente aqui.
                // O acesso é feito pelo botão "Acessar Agora".
                 document.getElementById('curationModal').classList.add('hidden');
            }
        };

        // O botão "Não" (ignorar) em modo não-embedded simplesmente fecha o modal ou vai para revisão sem adicionar.
        // Em modo embedded, este botão também não é primário. Se visível, poderia apenas fechar o modal.
        document.getElementById('curateNo').onclick = () => {
            if (!embeddedMode) {
                showReview(); // No modo normal, "Não" ainda pode levar à revisão (para desmarcar outros)
            } else {
                 // Em modo embedded, "Não" pode simplesmente fechar o modal se "Acessar Agora" não for clicado.
                document.getElementById('curationModal').classList.add('hidden');
            }
        };


        function showReview() {
            // Esta função é principalmente para o modo não-embedded (curadoria completa)
            if (embeddedMode) {
                // Não deve chegar aqui no fluxo de "Acessar Agora"
                document.getElementById('curationModal').classList.add('hidden');
                return;
            }
            document.getElementById('curationConfirm').style.display = 'none';
            document.getElementById('curationReview').style.display = 'block';
            const ul = document.getElementById('curationList'); ul.innerHTML = '';
            selection.forEach((c,i) => {
                const li = document.createElement('li');
                li.innerHTML = `<label><input type='checkbox' data-idx='${i}' checked> ${c.course_title}</label>`;
                ul.appendChild(li);
            });
        }

        // Atualiza seleção a partir das checkboxes da revisão
        function applyReview() {
            const newSel = [];
            document.querySelectorAll('#curationList input[type=checkbox]').forEach(cb => {
                if (cb.checked) newSel.push(selection[parseInt(cb.dataset.idx)]);
            });
            selection = newSel;
        }
        // Atualiza contagem no passo de confirmação
        function updateRemainingConfirm() {
            document.getElementById('curationRemaining').textContent =
                `Você pode selecionar ${MAX_SELECTION - selection.length} recurso${selection.length !== MAX_SELECTION - 1 ? 's' : ''}`;
        }
        document.getElementById('curateBack').onclick = () => {
            applyReview();
            updateRemainingConfirm();
            document.getElementById('curationReview').style.display = 'none';
            document.getElementById('curationConfirm').style.display = 'block';
        };
        document.getElementById('curateContinue').onclick = () => {
            applyReview();
            document.getElementById('curationModal').classList.add('hidden');
        };
        document.getElementById('curateFinish').onclick = () => {
            applyReview(); // Garante que a seleção da lista de checkboxes seja aplicada
            const finalList = selection;

            if (embeddedMode && parentOrigin) {
                // Em modo embedded, envia a lista de cursos para a página pai
                // A página pai será responsável por coletar nome/email se necessário
                window.parent.postMessage({ action: 'finalizarTrilha', trilhaData: finalList }, parentOrigin);
                document.getElementById('curationModal').classList.add('hidden');
                // Limpa a seleção para a próxima vez que o modal for aberto.
                selection = []; 
                updateRemainingConfirm();
            } else {
                // Comportamento original: prompt para nome/email e download JSON
                const name = prompt('Digite seu nome:');
                const email = prompt('Digite seu email:');
                if (!name || !email) {
                    alert('Nome e email são obrigatórios.');
                    return;
                }
                const payload = { name, email, courses: finalList };
                const dataStr = JSON.stringify(payload, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const fileName = `trilha_${name.replace(/\\s+/g,'_')}_${email.replace(/[@\\.]/g,'_')}.json`;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                document.getElementById('curationModal').classList.add('hidden');
                // Limpa a seleção
                selection = []; 
                updateRemainingConfirm();
            }
        };

        // RENOMEADA e AJUSTADA: Agora recebe uma ÚNICA categoria P.A.I. e renderiza seus itens.
        function displayPaiCategoryItems(paiCategory) {
            const container = document.getElementById('coursesContainer');
            container.innerHTML = ''; // Limpa conteúdo anterior

            const paiSectionTitle = document.createElement('h2');
            paiSectionTitle.className = 'category-title-header';
            paiSectionTitle.textContent = `Participe - ${paiCategory.name}`; // AJUSTADO: Titulo da seção para 'Participe'
            container.appendChild(paiSectionTitle);

            if ((!paiCategory.items || paiCategory.items.length === 0)) {
                const noItemsMessage = document.createElement('p');
                if (paiCategory.statusMessage) {
                    noItemsMessage.textContent = paiCategory.statusMessage;
                } else {
                    noItemsMessage.textContent = `Nenhum recurso encontrado na categoria F.A.I.: ${paiCategory.name}.`;
                }
                noItemsMessage.style.color = '#ccc';
                noItemsMessage.style.marginTop = '20px';
                container.appendChild(noItemsMessage);
                return;
            }

            const carouselTrack = document.createElement('div');
            carouselTrack.className = 'carousel-track';

            paiCategory.items.forEach(paiItem => {
                const card = document.createElement('div');
                card.className = 'course-card';

                card.addEventListener('click', () => {
                    openPaiItemInModal(paiItem);
                });

                card.innerHTML = `
                    <img src="${paiItem.image || 'https://via.placeholder.com/308x196.png?text=Recurso'}" alt="${paiItem.name}" style="width:100%; height:196px; object-fit:cover; border-bottom: 1px solid rgba(80, 48, 96, 0.9);">
                    <div class="info" style="padding:15px;">
                        <h3 style="margin:0 0 10px; font-size:1.05em; color:#fff; height: 56px; overflow: hidden;">${paiItem.name}</h3>
                        <p style="font-size:0.85em; color:#ccc; margin:0; line-height: 1.3; height: 70px; overflow: hidden;">Acesse Aqui</p>
                    </div>
                `;
                carouselTrack.appendChild(card);
            });
            container.appendChild(carouselTrack);

            const debouncedUpdateFocus = debounce(() => updateCarouselFocus(carouselTrack), 50);
            let scrollEndTimer = null;
            carouselTrack.addEventListener('scroll', () => {
                debouncedUpdateFocus();
                clearTimeout(scrollEndTimer);
                scrollEndTimer = setTimeout(() => {
                    snapToNearestCard(carouselTrack);
                }, 150);
            });

            setTimeout(() => {
                updateCarouselFocus(carouselTrack);
            }, 0);
        }

        function openPaiItemInModal(paiItem) {
            const modal = document.getElementById('paiModal');
            const titleElement = document.getElementById('paiModalTitle');
            const iframeElement = document.getElementById('paiModalIframe');

            if (!modal || !titleElement || !iframeElement) {
                console.error('Elementos do modal P.A.I. não encontrados.');
                return;
            }

            titleElement.textContent = paiItem.name;
            iframeElement.src = paiItem.url;
            modal.classList.remove('hidden');
        }

        function renderSuporteIaSubcategoriesSidebar() {
            const ul = document.getElementById('suporteIaItemsList');
            ul.innerHTML = ''; 

            if (!suporteIaCategoriesData || suporteIaCategoriesData.length === 0) {
                ul.innerHTML = '<li>Nenhuma subcategoria de Suporte IA configurada.</li>';
                return;
            }

            suporteIaCategoriesData.forEach(subCategory => {
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.textContent = subCategory.name;

                btn.addEventListener('click', () => {
                    ul.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    displayPaiCategoryItems(subCategory); 
                    closeSidebar(); // Fechar sidebar após selecionar subcategoria de Suporte IA
                });
                li.appendChild(btn);
                ul.appendChild(li);
            });
        }

        // Função para fechar a sidebar em mobile (definida globalmente)
        function closeSidebar() {
            if (window.innerWidth <= 768) { // Apenas em telas móveis
                document.body.classList.remove('sidebar-open');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const aside = document.querySelector('aside'); // Definir aside aqui para escopo
            const menuToggle = document.getElementById('menuToggle');
            const body = document.body;

            // Inicializa o menu mobile
            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    body.classList.toggle('sidebar-open');
                });
            }

            // Adiciona um listener para cliques fora da sidebar quando ela está aberta
            document.addEventListener('click', (event) => {
                if (body.classList.contains('sidebar-open') &&
                    !aside.contains(event.target) &&
                    !menuToggle.contains(event.target)) {
                    closeSidebar();
                }
            });

            adjustForEmbeddedMode(); 
            fetchCategories();
            renderPaiCategoriesSidebar(); 
            renderSuporteIaSubcategoriesSidebar(); // Re-adicionando esta chamada
            renderParticipeCategoriesSidebar(); // Adicionando chamada para renderizar a nova categoria 'Participe'

            const paiModal = document.getElementById('paiModal');
            const paiModalClose = document.getElementById('paiModalClose');
            const paiModalIframe = document.getElementById('paiModalIframe');

            if (paiModal && paiModalClose && paiModalIframe) {
                paiModalClose.addEventListener('click', () => {
                    paiModal.classList.add('hidden');
                    paiModalIframe.src = 'about:blank'; // Limpa o iframe para parar carregamento
                });
            }

            // Accordion functionality for sidebar
            document.querySelectorAll('aside .accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.accordion-icon');
                    const isFaiHeader = header.textContent.trim().startsWith('Ferramentas - Acesso Imediato');
                    const isSuporteIaHeader = header.textContent.trim().startsWith('Suporte - Inteligencia Artificial');
                    const isParticipeHeader = header.textContent.trim().startsWith('Participe'); // Nova verificação
                    
                    if (!content) return;

                    const isVisible = content.style.display === 'block';
                    
                    document.querySelectorAll('aside .accordion-content').forEach(c => {
                        if (c !== content) {
                            c.style.display = 'none';
                            const otherIcon = c.previousElementSibling.querySelector('.accordion-icon');
                            if (otherIcon) otherIcon.textContent = '▼';
                        }
                    });

                    content.style.display = isVisible ? 'none' : 'block';
                    if (icon) {
                        icon.textContent = isVisible ? '▼' : '▲';
                    }

                    // Se o acordeão P.A.I. foi aberto, configura a área de conteúdo.
                    if (isFaiHeader && !isVisible) { // !isVisible significa que ESTÁ SENDO ABERTO
                        // Limpa o container principal e mostra uma mensagem para selecionar uma subcategoria P.A.I.
                        document.getElementById('coursesContainer').innerHTML = '<p style="color: #ccc; text-align: center; margin-top: 50px; font-size: 1.2em;">Selecione uma subcategoria de Suporte - IA na lista.</p>';
                    } else if (isFaiHeader && isVisible) {
                        // Acordeão F.A.I. foi fechado, reseta para a mensagem padrão geral
                        document.getElementById('coursesContainer').innerHTML = '<p style="color: #ccc; text-align: center; margin-top: 50px; font-size: 1.2em;">Selecione um conteúdo ou ferramenta ao lado.</p>';
                    } else if (isSuporteIaHeader && !isVisible) {
                        // Acordeão Suporte - IA foi aberto
                        // Limpa o container e mostra mensagem para selecionar subcategoria
                        document.getElementById('coursesContainer').innerHTML = '<p style="color: #ccc; text-align: center; margin-top: 50px; font-size: 1.2em;">Selecione uma subcategoria de Suporte - IA na lista.</p>';
                    } else if (isSuporteIaHeader && isVisible) {
                        // Acordeão Suporte - IA foi fechado
                        document.getElementById('coursesContainer').innerHTML = '<p style="color: #ccc; text-align: center; margin-top: 50px; font-size: 1.2em;">Selecione um conteúdo ou ferramenta ao lado.</p>';
                    } else if (isParticipeHeader && !isVisible) { // Lógica para a nova categoria 'Participe'
                        document.getElementById('coursesContainer').innerHTML = '<p style="color: #ccc; text-align: center; margin-top: 50px; font-size: 1.2em;">Selecione uma opção da categoria Participe na lista.</p>';
                    } else if (isParticipeHeader && isVisible) {
                        document.getElementById('coursesContainer').innerHTML = '<p style="color: #ccc; text-align: center; margin-top: 50px; font-size: 1.2em;">Selecione um conteúdo ou ferramenta ao lado.</p>';
                    } else if (!isFaiHeader && !isSuporteIaHeader && !isVisible) {
                        // Acordeão de Conteúdo de Apoio (ou outro) foi aberto
                        document.getElementById('coursesContainer').innerHTML = '<p style="color: #ccc; text-align: center; margin-top: 50px; font-size: 1.2em;">Selecione uma categoria ao lado para ver os recursos.</p>';
                    } else if (!isFaiHeader && !isSuporteIaHeader && isVisible){
                        // Acordeão de Conteúdo de Apoio (ou outro) foi fechado
                        document.getElementById('coursesContainer').innerHTML = '<p style="color: #ccc; text-align: center; margin-top: 50px; font-size: 1.2em;">Selecione um conteúdo ou ferramenta ao lado.</p>';
                    }
                });
            });
        });

        function renderPaiCategoriesSidebar() {
            const paiListUl = document.getElementById('paiItemsList');
            paiListUl.innerHTML = ''; // Limpa itens anteriores, como "Nenhum item P.A.I configurado."

            if (!paiCategoriesData || paiCategoriesData.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'Nenhuma categoria P.A.I. configurada.';
                paiListUl.appendChild(li);
                return;
            }

            paiCategoriesData.forEach(paiCategory => {
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.textContent = paiCategory.name;
                // Adiciona a classe 'active' ao primeiro botão por padrão ou com base em estado salvo
                // if (index === 0) btn.classList.add('active'); 

                btn.addEventListener('click', () => {
                    // Remove 'active' de todos os botões P.A.I.
                    paiListUl.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    // Adiciona 'active' ao botão clicado
                    btn.classList.add('active');
                    // Exibe os itens da categoria P.A.I. selecionada
                    displayPaiCategoryItems(paiCategory);
                    closeSidebar(); // Fechar sidebar após selecionar categoria P.A.I.
                });

                li.appendChild(btn);
                paiListUl.appendChild(li);
            });
        }

        function renderParticipeCategoriesSidebar() {
            const participeListUl = document.getElementById('participeItemsList');
            participeListUl.innerHTML = '';

            if (!participeCategoriesData || participeCategoriesData.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'Nenhuma categoria de Participação configurada.';
                participeListUl.appendChild(li);
                return;
            }

            participeCategoriesData.forEach(participeCategory => {
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.textContent = participeCategory.name;

                btn.addEventListener('click', () => {
                    participeListUl.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    displayPaiCategoryItems(participeCategory); // Reutiliza a função de exibição de itens
                    closeSidebar();
                });

                li.appendChild(btn);
                participeListUl.appendChild(li);
            });
        }
    </script>
</body>
</html> 
